<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1.0,minimum-scale=1.0,maximum-scale=1.0,user-scalable=no"/>
    <title>Title</title>
    <link rel="stylesheet" href="css/login.css">
    <link rel="stylesheet" href="css/common.css">
</head>
<body>
<div class="container">
     <div class="top">
            <div class="option_1">
                <span>手机号</span>
                <input id="phone" type="text" size="15" placeholder="请输入手机号" class="edit">
                <span id="sendSmsBtn" class="rightWord" onclick="sendSMS();">获取验证码</span>
                <div class="hr"></div>
            </div>
            <div class="option_2">
                <span>验证码</span>
                <input id="code" type="text" size="15" placeholder="请输入验证码" class="edit">
                <div class="hr"></div>
            </div>
     </div>
    <button class="btn" onclick="login()">开启定制之旅</button>
</div>
<script src="https://cdn.bootcss.com/jquery/3.3.1/jquery.min.js"></script>
<script src="https://cdn.bootcss.com/layer/3.1.0/layer.js"></script>
<script src="js/common.js"></script>
<script type="text/javascript">

    $('div[class=container]').height($(window).height());
    $('div[class=container]').css('padding-top', '20%');

    var countdown=60;
    var interval;
    var lock = false;
    function sendSMS() {
        if (lock){
            return;
        }
        lock = true;
        var phone = $('#phone').val();
        if (phone.length!=11 || phone.trim()==''){
            myAlert('手机号不存在');
            return;
        }
        $.ajax({
            url: 'http://measure.justalit.com:8068/sms/get/'+phone,
            // url: 'http://localhost:8068/sms/get/'+phone,
            type: "get",
            xhrFields:{
                withCredentials:true
            },
            success: function (data) {
                if (data.toUpperCase() == 'OK'){
                    interval = setInterval(function () {
                        countdown--;
                        if (countdown == 0){
                            clearInterval(interval);
                            $('#sendSmsBtn').html('重新发送');
                            countdown = 60;
                            lock = false;
                        }else{
                            $('#sendSmsBtn').html('重新发送('+countdown+')');
                        }
                    }, 1000);
                }else if(data == 'isv.MOBILE_NUMBER_ILLEGAL') {
                    myAlert('手机号不存在');
                    lock = false;
                }else if(data == 'isv.OUT_OF_SERVICE') {
                    myAlert('发验证码账号已停机，请等待相关人员处理~~');
                    lock = false;
                }else if(data == 'isv.AMOUNT_NOT_ENOUGH') {
                    myAlert('发验证码账号余额不足，请等待相关人员处理~~');
                    lock = false;
                }else if(data == 'isv.BUSINESS_LIMIT_CONTROL') {
                    myAlert('请求验证码太频繁了，请稍后发送~~');
                    lock = false;
                }else{
                    myAlert('未知错误');
                    lock = false;
                }
            },
            error: function(data) {
                myAlert('未知错误');
                lock = false;
            }
        });
    }

    function login() {
        var phone = $('#phone').val();
        var code = $('#code').val();

        if (code.trim() == '') {
            myAlert('请输入验证码');
            return;
        }

        if (code.length != 6){
            myAlert('验证码格式错误');
            return;
        }

        $.ajax({
            // url: 'http://localhost:8068/sms/ok/'+phone+'/'+code,
            url: 'http://measure.justalit.com:8068/sms/ok/'+phone+'/'+code,
            type: "get",
            xhrFields:{
                withCredentials:true
            },
            success: function (data) {
                if (data == 'true'){
                    location.href = '/index.html';
                }else {
                    myAlert('验证码错误')
                }
            },
            error: function(data) {
                myAlert('未知错误');
            }
        });
    }

</script>
</body>
</html>
